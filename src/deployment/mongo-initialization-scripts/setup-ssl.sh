#!/bin/bash

# ============================================
# –°–ö–†–ò–ü–¢ –£–°–¢–ê–ù–û–í–ö–ò SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê
# ============================================
# –ü–æ–ª—É—á–∞–µ—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç Let's Encrypt

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "=========================================="
echo "  –£–°–¢–ê–ù–û–í–ö–ê SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–æ–º–µ–Ω —É–∫–∞–∑–∞–Ω
if [ -z "$DOMAIN" ]; then
    echo "‚ùå DOMAIN –Ω–µ —É–∫–∞–∑–∞–Ω –≤ config.sh"
    exit 1
fi

echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL –¥–ª—è –¥–æ–º–µ–Ω–∞: ${DOMAIN}"
echo "üìß Email: ${EMAIL}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS..."
echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Google DNS (8.8.8.8)..."
RESOLVED_IP=$(dig @8.8.8.8 +short ${DOMAIN} | tail -n1)

if [ -z "$RESOLVED_IP" ]; then
    echo "   ‚ùå –î–æ–º–µ–Ω –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è!"
    echo ""
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:"
    echo "   1. DNS –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ (A-–∑–∞–ø–∏—Å—å: ${DOMAIN} -> ${SERVER_IP})"
    echo "   2. DNS —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª—Å—è (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-60 –º–∏–Ω—É—Ç)"
    echo ""
    echo "   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   dig @8.8.8.8 +short ${DOMAIN}"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —ç—Ç–æ? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
else
    echo "   ‚úÖ –î–æ–º–µ–Ω —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –≤: ${RESOLVED_IP}"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ IP —Å–µ—Ä–≤–µ—Ä–∞
    SERVER_CURRENT_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || echo "unknown")
    
    if [ "$RESOLVED_IP" == "$SERVER_CURRENT_IP" ] || [ "$RESOLVED_IP" == "$SERVER_IP" ]; then
        echo "   ‚úÖ DNS —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä"
    else
        echo "   ‚ö†Ô∏è  DNS —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–π IP!"
        echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è: ${SERVER_IP}"
        echo "   –ü–æ–ª—É—á–µ–Ω–æ:  ${RESOLVED_IP}"
        echo ""
        read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm
        if [ "$confirm" != "yes" ]; then
            echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
            exit 1
        fi
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞ –ø–æ HTTP
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ HTTP..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${DOMAIN} || echo "000")

if [ "$HTTP_CODE" == "401" ] || [ "$HTTP_CODE" == "200" ]; then
    echo "   ‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP –∫–æ–¥: ${HTTP_CODE})"
elif [ "$HTTP_CODE" == "000" ]; then
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∞–π—Ç—É"
    echo "   –í–æ–∑–º–æ–∂–Ω–æ DNS –µ—â–µ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª—Å—è"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
else
    echo "   ‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π HTTP –∫–æ–¥: ${HTTP_CODE}"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo ""
echo "üîê –ó–∞–ø—É—Å–∫ Certbot –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
echo ""

sudo certbot --nginx \
    -d ${DOMAIN} \
    --non-interactive \
    --agree-tos \
    -m ${EMAIL} \
    --redirect

if [ $? -eq 0 ]; then
    echo ""
    echo "=========================================="
    echo "  ‚úÖ SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢ –£–°–¢–ê–ù–û–í–õ–ï–ù"
    echo "=========================================="
    echo ""
    echo "üéâ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è: ${DOMAIN}"
    echo ""
    echo "üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ:"
    sudo certbot certificates -d ${DOMAIN}
    echo ""
    echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ:"
    echo "   Certbot –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ"
    echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞: sudo certbot renew --dry-run"
    echo ""
    echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
    echo "   https://${DOMAIN}"
    echo ""
    echo "üîí HTTP –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ HTTPS"
    echo ""
else
    echo ""
    echo "=========================================="
    echo "  ‚ùå –û–®–ò–ë–ö–ê –£–°–¢–ê–ù–û–í–ö–ò SSL"
    echo "=========================================="
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  1. DNS –µ—â–µ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª—Å—è"
    echo "  2. –ü–æ—Ä—Ç—ã 80/443 –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ"
    echo "  3. –î–æ–º–µ–Ω –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä"
    echo ""
    echo "–î–ª—è –æ—Ç–ª–∞–¥–∫–∏:"
    echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS: dig @8.8.8.8 ${DOMAIN}"
    echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã: sudo netstat -tlnp | grep -E ':(80|443)'"
    echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -u nginx -n 50"
    echo "  ‚Ä¢ –õ–æ–≥–∏ Certbot: sudo cat /var/log/letsencrypt/letsencrypt.log"
    echo ""
    exit 1
fi
